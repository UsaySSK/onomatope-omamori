<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>今日のオノマトペ占い</title>
    <style>
        /* ページ全体の中央に表示し、余白をなくすためのスタイル */
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 画面全体の高さ */
            background-color: #222; /* 背景色 */
        }
        /* Pygameが表示されるキャンバスのスタイル */
        canvas {
            border: 1px solid #444; /* 枠線 */
            /* 画面サイズに合わせて調整したい場合は max-width/height を使用 */
            max-width: 100vw;
            max-height: 100vh;
        }
    </style>
</head>
<body>
    <canvas id="pygame-canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <script type="text/javascript">
        async function main() {
            console.log("Starting Pyodide application...");

            // Pyodideの読み込み
            console.log("Step 1: Loading Pyodide core...");
            let pyodide = await loadPyodide();
            console.log("Step 1 Complete: Pyodide core loaded.");

            // micropipとpygame-wasmをPyodideにロード
            // v0.25.0では個別にloadPackageを呼び出すか、
            // micropipを使ってインストールします。
            // ここでは直接パッケージをロードする方法を使います。
            console.log("Step 2: Loading 'micropip' package...");
            await pyodide.loadPackage("micropip");
            console.log("Step 2 Complete: 'micropip' loaded.");

            console.log("Step 3: Loading 'pygame-wasm' package...");
            await pyodide.loadPackage("pygame-wasm");
            console.log("Step 3 Complete: 'pygame-wasm' loaded.");

            // ZIPファイルをダウンロードし、Pyodideの仮想ファイルシステムに展開
            console.log("Step 4: Fetching assets.zip...");
            const zipResponse = await fetch("assets.zip");
            if (!zipResponse.ok) { // エラーチェックを追加
                console.error("Error: Failed to fetch assets.zip:", zipResponse.status, zipResponse.statusText);
                return; // 処理を中断
            }
            const zipBuffer = await zipResponse.arrayBuffer();
            pyodide.FS.unpackArchive(zipBuffer, "/", "zip");
            console.log("Step 4 Complete: assets.zip unpacked.");

            // main.pyをダウンロードし、Pyodideの仮想ファイルシステムに書き込み
            console.log("Step 5: Fetching main.py...");
            const mainPyResponse = await fetch("main.py");
            if (!mainPyResponse.ok) { // エラーチェックを追加
                console.error("Error: Failed to fetch main.py:", mainPyResponse.status, mainPyResponse.statusText);
                return; // 処理を中断
            }
            const mainPyCode = await mainPyResponse.text();
            pyodide.FS.writeFile("main.py", mainPyCode);
            console.log("Step 5 Complete: main.py loaded.");

            // Pygameのキャンバス要素をPyodideに渡す
            pyodide.globals.set("canvas_id", "pygame-canvas");

            // Pythonコードを実行
            console.log("Step 6: Running main.py...");
            try {
                await pyodide.runPythonAsync(`
                    import sys
                    import os
                    # Pygame-wasmが標準出力/エラー出力をHTMLのコンソールにリダイレクトするように設定
                    sys.stdout.flush = sys.stdout.softspace = None
                    sys.stderr.flush = sys.stderr.softspace = None

                    # Pyodideの仮想ファイルシステムのルートにいることを確認
                    os.chdir('/')
                    
                    # main.pyを実行
                    exec(open('main.py').read())
                `);
                console.log("Step 6 Complete: main.py finished.");
            } catch (error) {
                console.error("Error during Python code execution:", error);
            }
            console.log("Pyodide application finished.");
        }
        main();
    </script>
</body>
</html>
